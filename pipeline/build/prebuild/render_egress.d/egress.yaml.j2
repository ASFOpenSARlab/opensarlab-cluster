---

apiVersion: v1
kind: Namespace
metadata:
  name: external

---

apiVersion: telemetry.istio.io/v1alpha1
kind: Telemetry
metadata:
  name: mesh-default
  namespace: istio-system
spec:
  accessLogging:
    - providers:
        - name: envoy

---

{%- for service_entry in workloads['service_entry'] %}
{%- set hosts = service_entry['host'] %}
{%- set ips = service_entry['ip'] %}
{%- set profile = service_entry['profile'] %}
{%- set port = service_entry['port'] %}
{%- set lab = service_entry['lab'] %}
{%- set namespace = service_entry['namespace'] %}

{%- if hosts is defined and hosts | length > 0 %}
apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: {{ lab }}-{{ profile }}-{{ port }}
  namespace: external
spec:
  hosts:
  {%- for host in hosts %}
    - "{{ host }}"
  {%- endfor %}
  ports:
    - number: {{ port }}
      name: http-{{ port }}
      {%- if port in [443] %}
      protocol: HTTPS
      {%- else %}
      protocol: HTTP
      {%- endif %}
  resolution: DNS
  location: MESH_EXTERNAL
  exportTo:
    - "."
    - "{{ namespace }}"
---

{%- endif %}

{%- if ips is defined and ips | length > 0 %}
apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: {{ lab }}-{{ profile }}-{{ port }}-ips
  namespace: external
spec:
  hosts:
    - "local.local"
  addresses:
  {%- for ip in ips %}
    - "{{ ip }}"
  {%- endfor %}
  ports:
    - number: {{ port }}
      name: http-{{ port }}
      {%- if port in [443] %}
      protocol: HTTPS
      {%- else %}
      protocol: HTTP
      {%- endif %}
  resolution: NONE
  location: MESH_EXTERNAL
  exportTo:
    - "."
    - "{{ namespace }}"
---

{%- endif %}
{% endfor %}

{%- for sidecar in workloads['sidecar'] %}
{%- set lab = sidecar['lab'] %}
{%- set profile = sidecar['profile'] %}
{%- set namespace = sidecar['namespace'] %}
{%- set hosts = sidecar['host'] %}
apiVersion: networking.istio.io/v1beta1
kind: Sidecar
metadata:
  name: {{ lab }}-{{ profile }}
  namespace: {{ namespace }}
spec:
  outboundTrafficPolicy: 
    mode: "REGISTRY_ONLY"
  workloadSelector:
    labels:
      se-lab: {{ lab }}
      se-profile: {{ profile }}
  egress:
    - hosts:
      {%- for host in hosts %}
        - "external/{{ host }}"
      {%- endfor %}
---
{% endfor %}
