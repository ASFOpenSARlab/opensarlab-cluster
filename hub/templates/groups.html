{% extends "page.html" %}
{% if announcement_login %}
  {% set announcement = announcement_login %}
{% endif %}

{% block login_widget %}
{% endblock %}

{% block main %}

<style>

    #groups-main {
    }

    #groups-main thead th, tfoot th {
        font-family: 'Rock Salt', cursive;
    }

    #groups-main th {
        letter-spacing: 2px;
        padding: 10px;
    }

    #groups-main td {
        letter-spacing: 1px;
        padding: 10px;
    }

    #groups-main tbody td {
        text-align: center;
    }

    #groups-main tfoot th {
        text-align: right;
    }

    #groups-main .delete-group-button {
        color: orange;
        opacity: 0.5;
        transition: 0.3s;
        cursor: pointer;
    }

    #groups-main .delete-group-button:hover {
        opacity: 1;
    }

</style>


<div id="groups-main" class="container">
    <table id="users-groups">
        <thead>
            <tr>
                <th>Username</th>
                {% for group in groups %}
                <th class="group-name" data-group="{{ group.name }}"> {{ group.name }} <span class="delete-group-button" title="Delete group {{ group.name }}"> [x] </span> </th>
                {% endfor %}
                <th id="add-group"> <input id="add-group-box" type='text' size='20' placeholder='New Group Name'/> </th>
            </tr>
        </thead>
        <tbody>
           {% for user in all_users %}
           <tr data-user="{{ user.name }}">
               <td class="user-name" data-user="{{ user.name }}"> {{ user.name }} </td>
               {% for group in groups %}
                   <td class="group-checkbox" data-user="{{ user.name }}" data-group="{{ group.name }}">
                   {% if user.name in group.members %}
                   <input type="checkbox" title="Group: {{ group.name }}, User: {{ user.name }}" checked />
                   {% else %}
                   <input type="checkbox" title="Group: {{ group.name }}, User: {{ user.name }}" />
                   {% endif %}
                   </td>
               {% endfor %}
           </tr>
           {% endfor %}
        </tbody>
    </table>
</div>

<script>

    $('.group-checkbox').change(function() {
        user_name = $(this).data("user");
        group_name = $(this).data("group");
        change_to_checked = $(this).children('input')[0].checked;
        console.log("User '" + user_name + "' has been updated for group '" + group_name + "' because 'checked' is " + change_to_checked);
        this_data = {
            "user_name": user_name,
            "group_name": group_name,
            "change_to_checked": change_to_checked,
            "operation": "checked"
        }
        var jqxhr = $.post( "/hub/groups", this_data)
            .done(function() {
              console.log("Success");
            })
            .fail(function(result) {
              console.log("Error: " + result)
            })
    });

    $('#add-group-box').on('keydown', function(e) {
        if (e.keyCode == 13) {
            group_name = $(this).val();
            console.log("Group '" + group_name + "' is being added to DB table" );
            this_data = {
                "group_name": group_name,
                "operation": "add_group"
            };
            var jqxhr = $.post( "/hub/groups", this_data)
                .done(function() {

                  // Insert table header into second-last column with name of group (to bump group box over one)
                  th = '<th class="group-name" data-group="' + group_name + '"> ' + group_name + ' </th>';
                  $("#add-group").before(th).val('')

                  // Loop down through rows, appending cell with name of group and username
                  $("#users-groups tbody tr").each(function(){
                      user_name = $(this).data("user");
                      td = '<td class="group-checkbox" data-user="' + user_name + '" data-group="' + group_name + '"> <input type="checkbox" title="Group: ' + group_name + ', User: ' + user_name + '"/> </td>';
                      $(this).append(td)
                  });
                })
                .fail(function(result) {
                  console.log("Error: " + result)
                })
        }
    });

    $('.delete-group-button').on('click', function(e) {
        group_name = $(this).parent().data("group");
        console.log("Group '" + group_name + "' is being deleted from DB table" )
        this_data = {
            "group_name": group_name,
            "operation": "delete_group"
        }
        var jqxhr = $.post( "/hub/groups", this_data)
            .done(function(res) {
              console.log("Success " + res)
              // Delete matching table column
              $('.group-name').filter('[data-group="' + group_name + '"]').remove()
              $('.group-checkbox').filter('[data-group="' + group_name + '"]').remove()
            })
            .fail(function(result) {
              console.log("Error: " + result)
            })
    });

</script>


{% endblock %}

{% block script %}
{{ super() }}

{% endblock %}
