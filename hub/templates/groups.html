{% extends "page.html" %}
{% if announcement_login %}
  {% set announcement = announcement_login %}
{% endif %}

{% block login_widget %}
{% endblock %}

{% block main %}

<style>

    #groups-main {
    }

    #groups-main thead th, tfoot th {
      font-family: 'Rock Salt', cursive;
    }

    #groups-main th {
      letter-spacing: 2px;
      padding: 10px;
    }

    #groups-main td {
      letter-spacing: 1px;
      padding: 10px;
    }

    #groups-main tbody td {
      text-align: center;
    }

    #groups-main tfoot th {
      text-align: right;
    }
</style>


<div id="groups-main" class="container">
    <table id="users_groups">
        <thead>
            <tr>
                <th>Username</th>
                {% for group in groups %}
                <th class="group-name" data-group="{{ group.name }}"> {{ group.name }} </th>
                {% endfor %}
                <th> <input id="add_group_box" type='text' size='20' placeholder='New Group Name'/> </th>
            </tr>
        </thead>
        <tbody>
           {% for user in all_users %}
           <tr>
                   <td class="user-name" data-user="{{ user.name }}"> {{ user.name }} </td>
                   {% for group in groups %}
                       <td class="group_checkbox" data-user="{{ user.name }}" data-group="{{ group.name }}">
                       {% if user.name in group.members %}
                       <input type="checkbox" checked />
                       {% else %}
                       <input type="checkbox" />
                       {% endif %}
                       </td>
                   {% endfor %}
           </tr>
           {% endfor %}
        </tbody>
    </table>
</div>

<script>
    $('.group_checkbox > input[checkbox]').change(function() {
        user_name = this.parent.dataset.user;
        group_name = this.parent.dataset.group;
        change_to_checked = this.checked;
        console.log("User '" + user_name + "' has been updated for group '" + group_name + "'");
        this_data = {
            "user_name": user_name,
            "group_name": group_name,
            "change_to_checked": change_to_checked,
            "operation": "checked"
        }
        var jqxhr = $.post( "/hub/groups", this_data)
            .done(function(result) {
              console.log("Success is " + result);
            })
            .fail(function(result) {
              console.log("Error: " + result)
            })
    });

    $('#add_group_box').on('keydown', function(e) {
        if (e.keyCode == 13) {
            group_name = $(this).val();
            console.log("Group '" + group_name + "' is being added to DB table" );
            this_data = {
                "group_name": group_name,
                "operation": "add_group"
            };
            var jqxhr = $.post( "/hub/groups", this_data)
                .done(function(result) {
                  console.log("Success is " + result);

                  // Insert table header into second-last column with name of group (to bump group box over one)
                  th = '<th class="group-name" data-group="' + group_name + '"> ' + group_name + ' </th>';
                  $("#users_groups th:last").prepend(th);

                  // Loop down through rows, appending cell with name of group and username
                  $("#users_groups tr:last").each(function(){
                      user_name = this.parent.dataset.user;
                      td = '<td class="group_checkbox" data-user="' + user_name + '" data-group="' + group_name + '"> <input type="checkbox" /> </td>';
                      $(this).append(td)
                  });
                })
                .fail(function(result) {
                  console.log("Error: " + result)
                })
        }
    });

    $('.delete_group_button').on('keydown', function(e) {
        if (e.keyCode == 13) {
            group_name = this.dataset.group;
            console.log("Group '" + group_name + "' is being deleted from DB table" )
            this_data = {
                "group_name": group_name,
                "operation": "delete_group"
            }
            var jqxhr = $.post( "/hub/groups", this_data)
                .done(function(result) {
                  console.log("Success is " + result);
                })
                .fail(function(result) {
                  console.log("Error: " + result)
                })
        }
    });

</script>


{% endblock %}

{% block script %}
{{ super() }}

{% endblock %}
