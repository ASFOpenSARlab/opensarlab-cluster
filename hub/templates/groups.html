{% extends "page.html" %}

{% block nav_bar_left_items %}
{{ super() }}
{% if user.admin %}
<li><a href="{{base_url}}groups">Groups</a></li>
{% endif %}
{% endblock %}  <!-- nav_bar_left_items -->

{% block stylesheet %}
{{ super() }}

<!--link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"-->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.21/datatables.min.css"/>
<style>

    #groups-main .delete-group-button {
        color: orange;
        opacity: 0.5;
        transition: 0.3s;
        cursor: pointer;
    }

    #groups-main .delete-group-button:hover {
        opacity: 1;
    }

    #groups-main .group-type-action {
        color: orange;
    }

    #groups-main .group-settings-container {
        padding: 10px 10px;
    }

    #groups-main .dropdown-container {
        position: relative;
    }

    #groups-main .all-users {
        background-color: #00d0ff70;
    }

    #groups-main .action-group {
        border-bottom-color: green;
        border-bottom-width: 2px;
    }

</style>
{% endblock %} <!-- stylesheet -->

{% block scripts %}
<!-- Override the default JS scripts since they are incompatible with datatables -->
<!-- require.js is overloaded so it doesn't crash. Require is not in a block so it can't be deleted. -->
<script> require = {}; require.config = function(){}; </script>
{% endblock %}

{% if announcement_login %}
  {% set announcement = announcement_login %}
{% endif %}

{% macro group_settings(group_name='new', description='', group_type='label', is_all_users=0, is_enabled=1, is_new=0) %}
<div class="group-settings-container dropdown-menu" role="menu" aria-labelledby="{{ group_name }}-add-group-button" data-group="{{ group_name }}">
    <form>
        <div class='form-group'>
            {% if is_new == 1 %}
            <label for="new-name-select">Group Name</label>
            <input id="new-name-select" class="name-select form-control" type='text' size='20' placeholder='New Group Name'/>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ group_name }}-description-select">Group Description</label>
            <textarea id="{{ group_name }}-description-select" class="description-select form-control" rows=3 maxlength=254 placeholder='Description of Group'>{{ description }}</textarea>
        </div>

        <div class="form-group">
            <div class="group-type-select" id="{{ group_name }}-group-type-select">
                <label class="col-form-label">Group Type</label>
                <div>
                    {% if group_type == 'action' %}
                    <div class="form-check">
                        <input class="form-check-input" type="radio" id="{{ group_name }}-group-type-select-label" value="label" name="{{ group_name }}-group-type">
                        <label class="form-check-label" for="{{ group_name }}-group-type-select-label">
                            label
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" id="{{ group_name }}-group-type-select-action" value="action" name="{{ group_name }}-group-type" checked>
                        <label class="form-check-label" for="{{ group_name }}-group-type-select-action">
                            action
                        </label>
                    </div>
                    {% else %}
                    <div class="form-check">
                        <input class="form-check-input" type="radio" id="{{ group_name }}-group-type-select-label" value="label" name="{{ group_name }}-group-type" checked>
                        <label class="form-check-label" for="{{ group_name }}-group-type-select-label">
                            label
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" id="{{ group_name }}-group-type-select-action" name="{{ group_name }}-group-type" value="action">
                        <label class="form-check-label" for="{{ group_name }}-group-type-select-action">
                            action
                        </label>
                    </div>
                    {% endif %}
                </div>
            </div>
         </div>

        <div class="form-group">
            {% if is_all_users == 1 %}
            <input type='checkbox' id="{{ group_name }}-is-all-users-select" class="is-all-users-select form-check-input" data-group="{{ group_name }}" checked />
            {% else %}
            <input type='checkbox' id="{{ group_name }}-is-all-users-select" class="is-all-users-select form-check-input" data-group="{{ group_name }}" />
            {% endif %}
            <label class="form-check-label" for="{{ group_name }}-is-all-users-select">All Users?</label>
        </div>

        <div class="form-group">
            {% if is_enabled == 1 %}
            <input type='checkbox' id="{{ group_name }}-is-enabled-select" class="is-enabled-select form-check-input" checked />
            {% else %}
            <input type='checkbox' id="{{ group_name }}-is-enabled-select" class="is-enabled-select form-check-input" />
            {% endif %}
            <label  class="form-check-label" for="{{ group_name }}-is-enabled-select">Is Enabled?</label>
        </div>

        {% if is_new == 1 %}
        <button class="btn btn-primary dropdown-item" id="new-submit-button">Add Group</button>
        {% else %}
        <button class="btn btn-primary dropdown-item group-update-button" id="{{ group_name }}-update-button" data-group="{{ group_name }}">Update Group</button>
    </form>

    <hr>

    <button class="btn btn-danger dropdown-item group-delete-button" id="{{ group_name }}-delete-button" data-group="{{ group_name }}">Delete Group</button>
    {% endif %}

</div>
{% endmacro %}

{% block main %}
<div id="groups-main" class="container">
    <table id="groups-main-table" class="stripe">
        <thead>
            <tr>
                <th>Username</th>
                {% for group in groups %}

                <th data-group="{{ group.group_name }}">
                    <div class="dropdown dropright">
                        <button class="btn btn-link dropdown-toggle {{ group.group_type }}-group" id="{{ group.group_name }}-add-group-button" type="button" data-toggle="dropdown">
                            <span class="h4">{{ group.group_name }}</span>
                        </button>
                        {{ group_settings(group_name=group.group_name, description=group.description, group_type=group.group_type, is_all_users=group.is_all_users, is_enabled=group.is_enabled, is_new=0) }}
                    </div>
                </th>
                {% endfor %}
                <th data-orderable="false">
                    <div class="dropdown dropright">
                        <button class="btn btn-warning dropdown-toggle" id="new-add-group-button" type="button" data-toggle="dropdown">
                            Add New Group
                        </button>
                        {{ group_settings(is_new=1) }}
                    </div>
                </th>
            </tr>
        </thead>
        <tbody>
           {% for user in all_users %}
           <tr data-user="{{ user.name }}">
                <td class="user-name" data-user="{{ user.name }}"> {{ user.name }} </td>
                {% for group in groups %}
                {% set enabled_class = "is-enabled-checkbox" if group.is_enabled else "is-disabled-checkbox" %}
                {% set disabled = "disabled" if (not group.is_enabled or group.is_all_users) else "" %}
                {% set checked = "checked" if user.name in group.members else "" %}
                {% set ordered = "true" if checked == "checked" else "false" %}
                {% set all_users_class = "all-users" if group.is_all_users else "" %}
                <td class="group-checkbox {{ all_users_class }} {{ enabled_class }}" data-user="{{ user.name }}" data-group="{{ group.group_name }}" data-order="{{ ordered }}">
                    <input type="checkbox" class="{{ enabled_class }}" title="Group: {{ group.group_name }}, User: {{ user.name }}" {{ checked }} {{ disabled }}/>
                </td>
                {% endfor %}
                <td>&nbsp;&nbsp;&nbsp;</td>
           </tr>
           {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %} <!-- main -->

{% block script %}
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.bundle.min.js"></script>
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/v/dt/dt-1.10.21/datatables.min.js"></script>
<script type="text/javascript" charset="utf8">

    function modal_handler(message, success, cancel) {

        $('#error-dialog .ajax-error').html(message);

        $('#error-dialog').off()

        $('#error-dialog').on("click", "button.btn-primary", function(e){
            $('#error-dialog').modal("hide");
            if (success) {
                success();
            }
        });

        $('#error-dialog').on("click", "button.btn-default", function(e){
            $('#error-dialog').modal("hide");
            if (cancel) {
                cancel();
            }
        });

        $('#error-dialog').modal("show");
    }

    // The class `fade` conflicts with another library and breaks the modal.
    // This will give a black backgrouns but at least the modal works.
    $('#error-dialog').removeClass('fade');

    $table = $('#groups-main-table');

    $table.DataTable();

    $table.on('change', '.group-checkbox', function(e) {

        e.stopPropagation()

        try {
            $this = $(this)
            user_name = $this.data("user");
            group_name = $this.data("group");
            change_to_checked = $this.children('input')[0].checked;
            console.log("User '" + user_name + "' has been updated for group '" + group_name + "' because 'checked' is " + change_to_checked);
            $this.data("order", "" + change_to_checked);
            this_data = {
                "user_name": user_name,
                "group_name": group_name,
                "change_to_checked": change_to_checked,
                "operation": "checked"
            }
            var jqxhr = $.post( "/hub/groups", this_data)
                .done(function() {
                    console.log("Success");
                })
                .fail(function(result) {
                    console.log("Error: ", result)
                    modal_handler("There was an error while checking a checkbox: <br/> " + result);
                })
        }
        catch(err) {
            modal_handler("There was an unusual error: <br/> " + err);
        }
    });

    $table.on('click', function(e) {

        e.stopPropagation()

        $target = $(e.target)

        if ( $target.is('#new-submit-button') )
        {   
            try {

                this_data = {
                    "group_name": $('#new-name-select').val(),
                    "description": $('#new-description-select').val(),
                    "group_type": $('#new-group-type-select input:checked').val(),
                    "is_all_users": $('#new-is-all-users-select')[0].checked,
                    "is_enabled": $('#new-is-enabled-select')[0].checked,
                    "operation": "add_group"
                };

                console.log("Group is being added to DB table:" + this_data );

                var jqxhr = $.post( "/hub/groups", this_data)
                    .done(function() {
                        console.log("This should not be printed. Instead, the page should be reloaded server side.");
                    })
                    .fail(function(result) {
                        console.log("Error: ", result)
                        throw "There was an error while adding a new group: " + result;
                    })

            }
            catch(err) {
                modal_handler("There was an unusual error: <br/> " + err);
            }
        }
        else if ( $target.is('.group-update-button') ) {

            try {

                group_name = $target.data("group");

                this_data = {
                    "group_name": group_name,
                    "description": $('#'+group_name +'-description-select').val(),
                    "group_type": $('#'+group_name +'-group-type-select input:checked').val(),
                    "is_all_users": $('#'+group_name +'-is-all-users-select')[0].checked,
                    "is_enabled": $('#'+group_name +'-is-enabled-select')[0].checked,
                    "operation": "update_group"
                };

                console.log("Group is being updated to DB table:" + this_data );

                var jqxhr = $.post( "/hub/groups", this_data)
                    .done(function() {
                        console.log("This should not be printed. Instead, the page should be reloaded server side.");
                    })
                    .fail(function(result) {
                        console.log("Error: " + result)
                        modal_handler("There was an error while adding a group: <br/> " + result);
                    })
            }
            catch(err) {
                modal_handler("There was an unusual error: <br/> " + err);
            }
        }
        else if ( $target.is('.group-delete-button') ) {

            try {

                group_name = $target.data("group");
                message = "Are you sure you want to delete the group '" + group_name + "'?";

                this_data = {
                    "group_name": group_name,
                    "operation": "delete_group"
                };

                modal_handler(message,
                    function(e){
                        this_data = {
                            "group_name": group_name,
                            "operation": "delete_group"
                        };
                        console.log("Group '" + group_name + "' is being deleted from DB table" )
                        var jqxhr = $.post( "/hub/groups", this_data)
                            .done(function(res) {
                                console.log("You should not be reading this. Instead, the page should be reloaded server side.");
                                console.log("However, if we get here we will jquery delete the column.")
                                el_th = 'th[data-group="' + group_name + '"]'
                                el_tr = 'th[data-group="' + group_name + '"]'
                                console.log("Deleting: " + el_tr + ' and ' + el_tr)
                                $(el_th).remove();
                                $(el_tr).remove();
                            })
                            .fail(function(result) {
                                console.log("Error: " + result)
                                modal_handler("There was an error while deleting a group:" + result);
                            })
                    },
                    function(e){
                        modal_handler("There was an unusual error: <br/> " + e);
                    }
                );
            }
            catch(err) {
                console.log(err)
                modal_handler("There was an unusual error: <br/> " + err);
            }
        }
        else if ( $target.is('th') ) {
            console.log("Sorting...")
        }
        else {
            console.log("Target evented: ", $target)
        }
    });

    console.log("Page loaded on " + new Date().toLocaleString());

</script>

{% endblock %} <!-- script -->
