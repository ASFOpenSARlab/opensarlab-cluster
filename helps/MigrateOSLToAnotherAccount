

Create new cluster

Add Banner on old OSL for scheduled downtime

Autorun special snapshot lifecycle manager run.

Stop all servers in Admin.
Disable Load Balance
    -> Go to EC2 > Target Groups 
    -> Click on wanted cluster LB 
    -> Select Registred Targets and Deregister
Check for no users via no active attached user EC2 volumes

Export then Import Cognito users. Users will need to reset their passwords.
    -> Use migrate_old_to_new.py script, migrate_users = True

Check if Cognito users are properly disabled as needed. If not, run sync_disabled.py script with proper values.

To speed up the password reset process, run the force_pass_start.py script to Confirm users.

** Make sure config values are correct **
Once lifecycle is done, migrate snapshots.
    -> Use migrate_old_to_new.py script, migrate_snapshots = True 

While waiting for snapshot migration, export hub DB from old account and import hub DB to new account.
    ->  sk opensarlab
        OLD_HUB_POD=$(kubectl get pods -l component=hub --no-headers -o custom-columns=":metadata.name")
        kubectl cp $OLD_HUB_POD:/srv/jupyterhub/jupyterhub.sqlite jupyterhub.sqlite.old-daac
        sk osl-daac-cluster
        NEW_HUB_POD=$(kubectl get pods -l component=hub --no-headers -o custom-columns=":metadata.name")
        kubectl cp jupyterhub.sqlite.old-daac $NEW_HUB_POD:/srv/jupyterhub/jupyterhub.sqlite.old-daac
        kubectl exec -it $NEW_HUB_POD -- bash
        cp /srv/jupyterhub/jupyterhub.sqlite /srv/jupyterhub/jupyterhub.sqlite.deprecated
        cp /srv/jupyterhub/jupyterhub.sqlite.old-daac /srv/jupyterhub/jupyterhub.sqlite
        exit
        kubectl delete pod $NEW_HUB_POD

    In new account Groups page create groups:
        SAR_1 
        SAR_1_-_Test 
        SAR_2 

        Make SAR 1 for all
        Migrate users from UNVACO to SAR 2
        Keep sudo the same
        Delete general_cpu, UNAVCO, and all other old groups (but sudo)

    revert: cp /srv/jupyterhub/jupyterhub.sqlite.deprecated /srv/jupyterhub/jupyterhub.sqlite

(Already done.) Update Banner on login page in new account.

Check New cluster 
    -> https://osl-daac-cluster-544079743.us-east-1.elb.amazonaws.com

Update ClusterDomain in Cognito CF to "https://opensarlab.asf.alaska.edu"
    Revert: https://osl-daac-cluster-544079743.us-east-1.elb.amazonaws.com

Update JupyterHubURL in Cluster CF to "https://opensarlab.asf.alaska.edu"
    Revert: -

If anything goes wrong before this point and a rollback is needed, update the old banner and reenable Load Balancer. Nothing else has been changed in the old DAAC.

Otherwise, update Puppet DNS with new Load Balancer URL for "opensarlab.asf.alaska.edu":
    ->  opensarlab                  IN  CNAME  opensarlab-9025836.us-east-1.elb.amazonaws.com.  ==> 
        opensarlab                  IN  CNAME  osl-daac-cluster-544079743.us-east-1.elb.amazonaws.com. 
Wait for Puppet

Double check cluster 

Reduce Old EC2 to zero.
After couple days, delete volumes. Daily snapshots will have ran.

(Manually update redirect app client config in Old Cognito to LB DNS.)
